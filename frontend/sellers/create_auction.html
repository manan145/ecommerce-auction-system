<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Create Auction - Seller</title>
  <link href="https://fonts.googleapis.com/css?family=Roboto:400,500&display=swap" rel="stylesheet">
  <style>
    body {
      margin: 0;
      font-family: 'Roboto', sans-serif;
      background: linear-gradient(135deg, #f5f7fa, #c3cfe2);
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }
    .container {
      width: 100%;
      max-width: 700px;
      background: #fff;
      padding: 30px 40px;
      border-radius: 10px;
      box-shadow: 0 8px 16px rgba(0, 0, 0, 0.15);
    }
    h1 {
      text-align: center;
      margin-bottom: 25px;
      color: #333;
      font-weight: 500;
    }
    label {
      display: block;
      margin-bottom: 5px;
      font-weight: 500;
      color: #555;
    }
    input, select, textarea {
      width: 100%;
      padding: 12px 15px;
      margin-bottom: 20px;
      border: 1px solid #ddd;
      border-radius: 5px;
      font-size: 14px;
      box-sizing: border-box;
      transition: border-color 0.3s ease;
    }
    input:focus, select:focus, textarea:focus {
      border-color: #5563DE;
      outline: none;
    }
    button {
      width: 100%;
      padding: 12px;
      background: #5563DE;
      border: none;
      color: #fff;
      font-size: 16px;
      font-weight: 500;
      border-radius: 5px;
      cursor: pointer;
      transition: background 0.3s ease;
    }
    button:hover {
      background: #435ac9;
    }
    .message {
      text-align: center;
      margin-bottom: 15px;
      font-size: 14px;
      color: #d8000c;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Create Auction</h1>
    <div id="auctionMessage" class="message"></div>
    <form id="createAuctionForm">
      <!-- Basic Item Details -->
      <label for="title">Title:</label>
      <input type="text" id="title" placeholder="Enter item title" required>
      
      <label for="description">Description:</label>
      <textarea id="description" rows="3" placeholder="Enter item description"></textarea>
      
      <label for="brand">Brand:</label>
      <input type="text" id="brand" placeholder="Enter brand" required>
      
      <label for="model">Model:</label>
      <input type="text" id="model" placeholder="Enter model" required>
      
      <!-- Condition -->
      <label for="condition">Condition:</label>
      <select id="condition" required>
        <option value="">-- Select Condition --</option>
        <option value="New">New</option>
        <option value="Used">Used</option>
        <option value="Refurbished">Refurbished</option>
        <option value="Open Box">Open Box</option>
      </select>
      
      <!-- For this implementation, we assume a single category "Electronics" -->
      <label>Category:</label>
      <input type="text" value="Electronics" readonly>
      
      <!-- Subcategory Dropdown -->
      <label for="subcategory">Subcategory:</label>
      <select id="subcategory" required>
        <option value="">-- Select Subcategory --</option>
      </select>
      
      <!-- Dynamic Attributes -->
      <div id="attributesContainer">
        <!-- Dynamic attribute fields will appear here -->
      </div>
      
      <!-- Auction Details -->
      <label for="startPrice">Start Price ($):</label>
      <input type="number" step="0.01" id="startPrice" placeholder="e.g., 50.00" required>
      
      <label for="minIncrement">Minimum Increment ($):</label>
      <input type="number" step="0.01" id="minIncrement" placeholder="e.g., 5.00" required>
      
      <label for="secretMinPrice">Secret Minimum Price (Reserve) ($):</label>
      <input type="number" step="0.01" id="secretMinPrice" placeholder="e.g., 100.00" required>
      
      <label for="startTime">Auction Start Time:</label>
      <input type="datetime-local" id="startTime" required>
      
      <label for="endTime">Auction End Time:</label>
      <input type="datetime-local" id="endTime" required>
      
      <button type="submit">Create Auction</button>
    </form>
  </div>
  
  <script>
    // New subcategory mapping with corresponding attributes as provided
    // Keys 1, 2, 3, 4 correspond to Laptops, Smartphones, Audio Accessories, and Monitors respectively.
    const subcategoriesData = {
      1: {
        name: "Laptops",
        attributes: [
          "Processor", "RAM", "Storage", "Screen Size", "Graphics Card",
          "Operating System", "Battery Life", "Weight", "Warranty"
        ]
      },
      2: {
        name: "Smartphones",
        attributes: [
          "Storage", "RAM", "Color", "Operating System", "Screen Size",
          "Camera", "Battery Capacity", "Network Support", "Warranty"
        ]
      },
      3: {
        name: "Audio Accessories",
        attributes: [
          "Type", "Wireless", "Noise Cancellation", "Battery Life",
          "Charging Port", "Color", "Mic Included", "Waterproof Rating", "Warranty"
        ]
      },
      4: {
        name: "Monitors",
        attributes: [
          "Screen Size", "Resolution", "Panel Type", "Refresh Rate", "Ports",
          "Response Time", "Aspect Ratio", "Adjustable Stand", "VESA Mount Support", "Warranty"
        ]
      }
    };

    // Populate the subcategory dropdown using subcategoriesData
    const subcategorySelect = document.getElementById('subcategory');
    const attributesContainer = document.getElementById('attributesContainer');

    function populateSubcategories() {
      subcategorySelect.innerHTML = '<option value="">-- Select Subcategory --</option>';
      Object.keys(subcategoriesData).forEach(key => {
        const option = document.createElement('option');
        option.value = key;
        option.textContent = subcategoriesData[key].name;
        subcategorySelect.appendChild(option);
      });
    }

    // Display dynamic attributes based on selected subcategory
    function showAttributes(subcatKey) {
      attributesContainer.innerHTML = ''; // Clear existing attributes
      if (subcatKey && subcategoriesData[subcatKey]) {
        const attrs = subcategoriesData[subcatKey].attributes;
        attrs.forEach(attrName => {
          const label = document.createElement('label');
          label.textContent = attrName + ":";
          const input = document.createElement('input');
          input.type = 'text';
          input.placeholder = `Enter ${attrName}`;
          // Using a data attribute to hold the attribute name; in a real app, you may use an attribute ID
          input.setAttribute('data-attribute-name', attrName);
          attributesContainer.appendChild(label);
          attributesContainer.appendChild(input);
        });
      }
    }

    // Initialize subcategory dropdown on page load
    populateSubcategories();

    subcategorySelect.addEventListener('change', function() {
      showAttributes(this.value);
    });

    // Handle form submission
    document.getElementById('createAuctionForm').addEventListener('submit', function(e) {
      e.preventDefault();

      const token = localStorage.getItem('token');
      if (!token) {
        window.location.href = 'login.html';
        return;
      }

      // Gather form data
      const title = document.getElementById('title').value.trim();
      const description = document.getElementById('description').value.trim();
      const brand = document.getElementById('brand').value.trim();
      const model = document.getElementById('model').value.trim();
      const condition = document.getElementById('condition').value;
      
      // For category, we assume it's fixed as "Electronics"
      const subcategory_id = subcategorySelect.value; // Expected to be one of 1, 2, 3, or 4
      
      const startPrice = document.getElementById('startPrice').value;
      const minIncrement = document.getElementById('minIncrement').value;
      const secretMinPrice = document.getElementById('secretMinPrice').value;
      const startTime = document.getElementById('startTime').value.replace('T', ' ') + ":00";
      const endTime = document.getElementById('endTime').value.replace('T', ' ') + ":00";

      // Gather attribute values
      const attributeElements = attributesContainer.querySelectorAll('input[data-attribute-name]');
      const attributes = [];
      attributeElements.forEach(input => {
        const attrName = input.getAttribute('data-attribute-name');
        const value = input.value.trim();
        if (value) {
          attributes.push({ attribute_name: attrName, value: value });
        }
      });
      
      // Construct payload. Note: Your seller_routes.py expects fields:
      // subcategory_id, title, description, brand, model, condition,
      // attributes (array), start_price, min_increment, secret_min_price, start_time, end_time.
      const payload = {
        subcategory_id: subcategory_id,
        title: title,
        description: description,
        brand: brand,
        model: model,
        condition: condition,
        attributes: attributes,
        start_price: startPrice,
        min_increment: minIncrement,
        secret_min_price: secretMinPrice,
        start_time: startTime,
        end_time: endTime
      };

      fetch('/add-item', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': 'Bearer ' + token
        },
        body: JSON.stringify(payload)
      })
      .then(response => response.json())
      .then(data => {
        document.getElementById('auctionMessage').textContent = data.message || data.error;
      })
      .catch(error => {
        console.error('Error:', error);
        document.getElementById('auctionMessage').textContent = 'An error occurred while creating the auction.';
      });
    });
  </script>
</body>
</html>
