<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>My Bids</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
</head>
<body class="container py-4">
  <h2 class="mb-4">My Bids</h2>
  <table class="table table-bordered table-hover">
    <thead class="table-light">
      <tr>
        <th>Item</th>
        <th>Amount</th>
        <th>Time</th>
        <th>Status</th>
        <th>Action</th>
      </tr>
    </thead>
    <tbody id="myBidTable"></tbody>
  </table>

  <script>
    const BASE_URL = 'http://127.0.0.1:5000';
    const token = localStorage.getItem('token');

    async function fetchMyBids() {
      try {
        const response = await fetch(`${BASE_URL}/buyer/my-bids`, {
          headers: {
            'Authorization': `Bearer ${token}`
          }
        });

        if (!response.ok) {
          const err = await response.json();
          alert(err.error || "Failed to fetch bids.");
          return;
        }

        const bids = await response.json();
        const table = document.getElementById("myBidTable");

        table.innerHTML = bids.map(b => {
          const amount = `$${parseFloat(b.amount).toFixed(2)}`;
          const bidTime = new Date(b.bid_time).toLocaleString();
          const status = b.is_closed ? 'Closed' : 'Active';
          let actionContent = '';

          // üîÑ START: UPDATED logic for action content
          if (!b.is_closed && b.is_highest_bidder) {
            actionContent = `<span class="badge bg-success">You are the highest bidder</span>`;
          } else if (b.won) {
            // Show Congrats + Payment actions
            actionContent = `
              <div class="d-flex flex-column gap-1">
                <span class="text-success fw-semibold">üéâ Congrats, you won!</span>
                ${
                  b.transaction_status === 'pending'
                    ? `<button class="btn btn-sm btn-primary" onclick="makePayment(${b.transaction_id})">Pay Now</button>`
                    : b.transaction_status === 'completed'
                      ? `<span class="badge bg-info text-dark">Payment Completed</span>`
                      : `<span class="badge bg-warning text-dark">Awaiting Payment Setup</span>`
                }
              </div>
            `;
          } else if (b.is_closed && !b.won) {
            actionContent = `<span class="badge bg-secondary">Auction Ended</span>`;
          }
          // üîÑ END: UPDATED logic for action content

          return `
            <tr>
              <td>${b.item_title || 'Unknown'}</td>
              <td>${amount}</td>
              <td>${bidTime}</td>
              <td>${status}</td>
              <td>${actionContent}</td>
            </tr>
          `;
        }).join('');
      } catch (err) {
        console.error("Error loading bids:", err);
        alert("An error occurred while loading bids.");
      }
    }

    async function makePayment(transactionId) {
      if (!token) {
        alert("You must be logged in to make a payment.");
        return;
      }

      try {
        const response = await fetch(`${BASE_URL}/buyer/make-payment`, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ transaction_id: transactionId })
        });

        const result = await response.json();
        if (response.ok) {
          alert("‚úÖ Payment successful!");
          fetchMyBids(); // refresh table
        } else {
          alert(`‚ùå ${result.error || 'Payment failed.'}`);
        }
      } catch (err) {
        console.error("Payment error:", err);
        alert("Something went wrong while making the payment.");
      }
    }

    fetchMyBids();
  </script>
</body>
</html>
