<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Open Queries - Rep Dashboard</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body {
      background-color: #f8f9fa;
      padding: 40px;
    }
    .container {
      max-width: 900px;
      background-color: white;
      padding: 30px;
      border-radius: 12px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
    }
    h3 {
      text-align: center;
      margin-bottom: 25px;
    }
    .query-card {
      border: 1px solid #dee2e6;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 15px;
    }
    .query-card small {
      color: #6c757d;
    }
  </style>
</head>
<body>

<div class="container">
  <h3>Open Customer Queries</h3>
  <div id="queriesList">
    <!-- Queries will be loaded here -->
  </div>
  <div id="message"></div>

  <!-- Subtle Go Back Link -->
  <div class="text-center mt-4">
    <a href="index.html" style="color: #6c757d; text-decoration: none;">‚Üê Back to Dashboard</a>
  </div>
</div>

<script>
  const token = localStorage.getItem('token');

  // Load queries
  fetch('http://127.0.0.1:5000/rep/queries', {
    method: 'GET',
    headers: {
      'Authorization': 'Bearer ' + token
    }
  })
  .then(res => res.json())
  .then(queries => {
    const container = document.getElementById('queriesList');
    if (queries.length === 0) {
      container.innerHTML = '<p class="text-muted">No open queries.</p>';
      return;
    }

    queries.forEach(q => {
      const card = document.createElement('div');
      card.className = 'query-card';
      card.innerHTML = `
        <p><strong>Subject:</strong> ${q.Subject}</p>
        <p><strong>Message:</strong> ${q.Message}</p>
        <small><strong>Query ID:</strong> ${q.QueryID} | <strong>User ID:</strong> ${q.UserID}</small><br>
        <small><strong>Created At:</strong> ${new Date(q.CreatedAt).toLocaleString()}</small><br>
        <textarea class="form-control mt-2" placeholder="Write your response here..." id="response-${q.QueryID}"></textarea>
        <button class="btn btn-sm btn-outline-primary mt-2" onclick="respondToQuery(${q.QueryID})">Respond</button>
        <button class="btn btn-sm btn-outline-success mt-2" onclick="closeQuery(${q.QueryID}, this)">Mark as Closed</button>
      `;
      container.appendChild(card);
    });
  });

  // Close query handler
  function closeQuery(queryId, button) {
    button.disabled = true;

    fetch('http://127.0.0.1:5000/rep/queries/close/' + queryId, { // Updated endpoint
      method: 'PUT',
      headers: {
        'Authorization': 'Bearer ' + token
      }
    })
    .then(res => res.json().then(data => ({ status: res.status, body: data })))
    .then(res => {
      if (res.status === 200) {
        button.parentElement.remove();
        showMessage('Query closed successfully.', 'success');
      } else {
        button.disabled = false;
        showMessage(res.body.error || 'Error closing query.', 'danger');
      }
    })
    .catch(err => {
      console.error('Network error:', err); // Log the error for debugging
      button.disabled = false;
      showMessage('Network error. Try again.', 'danger');
    });
  }

  function respondToQuery(queryId) {
    const response = document.getElementById(`response-${queryId}`).value.trim();
    if (!response) {
      showMessage('Response cannot be empty.', 'danger');
      return;
    }

    fetch('http://127.0.0.1:5000/rep/queries/respond/' + queryId, { // Updated endpoint
      method: 'PUT',
      headers: {
        'Authorization': 'Bearer ' + token,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({ response })
    })
    .then(res => res.json().then(data => ({ status: res.status, body: data })))
    .then(res => {
      if (res.status === 200) {
        showMessage('Response added successfully.', 'success');
      } else {
        showMessage(res.body.error || 'Error adding response.', 'danger');
      }
    })
    .catch(err => {
      console.error('Network error:', err); // Log the error for debugging
      showMessage('Network error. Try again.', 'danger');
    });
  }

  function showMessage(msg, type) {
    document.getElementById('message').innerHTML =
      `<div class="alert alert-${type} mt-3">${msg}</div>`;
  }
</script>

</body>
</html>
