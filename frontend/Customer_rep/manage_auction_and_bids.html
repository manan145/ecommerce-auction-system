<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Manage Auctions & Bids</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body {
      background-color: #f8f9fa;
      padding: 40px;
    }
    .container {
      max-width: 1200px;
      background-color: white;
      padding: 30px;
      border-radius: 12px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
    }
    .modal-body {
      max-height: 400px;
      overflow-y: auto;
    }
    .title {
      text-align: center;
    }
    .center-align {
      display: flex;
      justify-content: center;
      align-items: center;
    }
    .view-buttons {
      display: flex;
      justify-content: center;
      align-items: center; /* Vertically and horizontally center-align the buttons */
    }
    .btn {
      font-size: 14px; /* Ensure consistent font size for all buttons */
    }
  </style>
</head>
<body>
  <div class="container">
    <h3 class="mb-4 title">Manage Auctions & Bids</h3>
    <table class="table table-bordered">
      <thead class="table-light">
        <tr>
          <th>Item ID</th>
          <th>Auction ID</th>
          <th>Title</th>
          <th>Brand</th>
          <th>Subcategory</th>
          <th>Created At</th>
          <th>Specifications</th>
          <th>Auction Details</th>
          <th>Status</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody id="auctionTableBody">
        <script>
          const token = localStorage.getItem('token');

          let auctionData = [];

          // Fetch all auctions and populate the table
          fetch('http://127.0.0.1:5000/rep/auctions', {
            method: 'GET',
            headers: {
              'Authorization': 'Bearer ' + token
            }
          })
          .then(res => res.json())
          .then(data => {
            auctionData = data;
            const tableBody = document.getElementById('auctionTableBody');
            tableBody.innerHTML = '';

            data.forEach(item => {
              const row = document.createElement('tr');
              row.innerHTML = `
                <td>${item.ItemID}</td>
                <td>${item.AuctionID}</td>
                <td>${item.Title}</td>
                <td>${item.Brand}</td>
                <td>${item.Subcategory}</td>
                <td>${new Date(item.CreatedAt).toLocaleString()}</td>
                <td>
                  <div class="view-buttons">
                    <button class="btn btn-sm btn-info" onclick="viewSpecifications(${item.ItemID})">View</button>
                  </div>
                </td>
                <td>
                  <div class="view-buttons">
                    <button class="btn btn-sm btn-secondary" onclick="viewAuctionDetails(${item.AuctionID})">View</button>
                  </div>
                </td>
                <td>${item.Status}</td>
                <td>
                  <div class="action-buttons">
                    <button class="btn btn-sm btn-danger" onclick="deleteAuction(${item.AuctionID})">Delete Auction</button>
                    <button class="btn btn-sm btn-primary" onclick="manageBids(${item.AuctionID})">Manage Bids</button>
                  </div>
                </td>
              `;
              tableBody.appendChild(row);
            });
          })
          .catch(err => console.error('Failed to fetch auctions:', err));

          // View specifications in a modal
          function viewSpecifications(itemId) {
            fetch(`http://127.0.0.1:5000/public/browse/item-details/${itemId}`, {
              method: 'GET',
              headers: {
                'Authorization': 'Bearer ' + token
              }
            })
            .then(res => {
              if (!res.ok) {
                throw new Error('Failed to fetch item details');
              }
              return res.json();
            })
            .then(data => {
              const list = document.getElementById('specificationsList');
              list.innerHTML = '';
              if (data.Attributes && data.Attributes.length > 0) {
                data.Attributes.forEach(attr => {
                  const li = document.createElement('li');
                  li.textContent = `${attr.name}: ${attr.value}`;
                  list.appendChild(li);
                });
              } else {
                const li = document.createElement('li');
                li.textContent = 'No specifications available.';
                list.appendChild(li);
              }
              const modal = new bootstrap.Modal(document.getElementById('specificationsModal'));
              modal.show();
            })
            .catch(err => {
              console.error('Error fetching specifications:', err);
              alert('Failed to load specifications. Please try again later.');
            });
          }

          // Delete auction
          function deleteAuction(auctionId) {
            if (!confirm('Are you sure you want to delete this auction?')) return;

            fetch(`http://127.0.0.1:5000/rep/remove-auction/${auctionId}`, {
              method: 'DELETE',
              headers: {
                'Authorization': 'Bearer ' + token
              }
            })
            .then(res => res.json())
            .then(data => {
              alert(data.message);
              location.reload();
            })
            .catch(err => console.error('Failed to delete auction:', err));
          }

          // Manage bids for a specific auction
          async function manageBids(auctionId) {
            try {
              const res = await fetch(`http://127.0.0.1:5000/rep/bids/${auctionId}`, {
                method: 'GET',
                headers: {
                  'Authorization': 'Bearer ' + token
                }
              });
              const data = await res.json();

              const tableBody = document.getElementById('bidsTableBody');
              tableBody.innerHTML = '';

              if (!data.bids || data.bids.length === 0) {
                tableBody.innerHTML = `
                  <tr>
                    <td colspan="6" class="text-center text-muted">No bids found for this auction.</td>
                  </tr>
                `;
                const modal = new bootstrap.Modal(document.getElementById('bidsModal'));
                modal.show();
                return;
              }

              for (const bid of data.bids) {
                const bidderName = await fetchBidderName(bid.UserID);
                const row = document.createElement('tr');
                row.setAttribute('data-bid-id', bid.BidID); // Add data-bid-id attribute
                row.innerHTML = `
                  <td>${bid.BidID}</td>
                  <td>${bid.UserID}</td>
                  <td>${bidderName || 'N/A'}</td>
                  <td>$${bid.Amount.toFixed(2)}</td>
                  <td>${new Date(bid.Timestamp).toLocaleString()}</td>
                  <td>
                    <button class="btn btn-sm btn-danger" onclick="deleteBid(${bid.BidID})">Delete</button>
                  </td>
                `;
                tableBody.appendChild(row);
              }

              const modal = new bootstrap.Modal(document.getElementById('bidsModal'));
              modal.show();
            } catch (err) {
              console.error('Failed to fetch bids:', err);
              alert('An error occurred while fetching bids. Please try again later.');
            }
          }

          // Fetch bidder's username by UserID using the /rep/user API route
          async function fetchBidderName(userId) {
            try {
              const res = await fetch(`http://127.0.0.1:5000/rep/user`, {
                method: 'POST',
                headers: {
                  'Authorization': 'Bearer ' + token,
                  'Content-Type': 'application/json'
                },
                body: JSON.stringify({ user_id: userId })
              });
              if (res.ok) {
                const data = await res.json();
                return data.Username;
              }
            } catch (err) {
              console.error(`Failed to fetch username for UserID ${userId}:`, err);
            }
            return null;
          }

          // Delete a specific bid
          function deleteBid(bidId) {
            if (!confirm('Are you sure you want to delete this bid?')) return;

            fetch(`http://127.0.0.1:5000/rep/remove-bid/${bidId}`, {
              method: 'DELETE',
              headers: {
                'Authorization': 'Bearer ' + token
              }
            })
            .then(res => res.json())
            .then(data => {
              if (data.message) {
                alert(data.message);

                // Remove the bid row from the table
                const bidRow = document.querySelector(`#bidsTableBody tr[data-bid-id="${bidId}"]`);
                if (bidRow) {
                  bidRow.remove();
                }
              }
            })
            .catch(err => console.error('Failed to delete bid:', err));
          }

          function viewAuctionDetails(auctionId) {
            const auction = auctionData.find(a => a.AuctionID === auctionId);
            if (!auction) {
              alert('Auction not found.');
              return;
            }

            const modalBody = document.getElementById('auctionDetailsBody');
            modalBody.innerHTML = `
              <h5>Auction Details</h5>
              <p><strong>Auction ID:</strong> ${auction.AuctionID}</p>
              <p><strong>Start Price:</strong> $${auction.StartPrice}</p>
              <p><strong>Minimum Increment:</strong> $${auction.MinIncrement}</p>
              <p><strong>Secret Minimum Price:</strong> $${auction.SecretMinPrice}</p>
              <p><strong>Start Time:</strong> ${new Date(auction.StartTime).toLocaleString()}</p>
              <p><strong>End Time:</strong> ${new Date(auction.EndTime).toLocaleString()}</p>
              <p><strong>Is Closed:</strong> ${auction.IsClosed ? 'Yes' : 'No'}</p>
            `;
            const modal = new bootstrap.Modal(document.getElementById('auctionDetailsModal'));
            modal.show();
          }
        </script>
      </tbody>
    </table>
    <div class="mt-3 center-align">
      <a href="index.html" class="btn btn-secondary">Back to Dashboard</a>
    </div>
  </div>

  <!-- Modal for Viewing Specifications -->
  <div class="modal fade" id="specificationsModal" tabindex="-1" aria-labelledby="specificationsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="specificationsModalLabel">Item Specifications</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <ul id="specificationsList">
            <!-- Specifications will be dynamically populated -->
          </ul>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal for Viewing Auction Details -->
  <div class="modal fade" id="auctionDetailsModal" tabindex="-1" aria-labelledby="auctionDetailsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="auctionDetailsModalLabel">Auction Details</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body" id="auctionDetailsBody">
          <!-- Auction details will be dynamically inserted here -->
        </div>
      </div>
    </div>
  </div>

  <!-- Modal for Viewing Bids -->
  <div class="modal fade" id="bidsModal" tabindex="-1" aria-labelledby="bidsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="bidsModalLabel">Bid History</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <table class="table table-bordered">
            <thead>
              <tr>
                <th>Bid ID</th>
                <th>Bidder ID</th>
                <th>Bidder Name</th>
                <th>Amount</th>
                <th>Timestamp</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="bidsTableBody">
              <!-- Bids will be dynamically populated -->
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
